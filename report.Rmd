---
title: "Overview report"
output: pdf_document
params:
  time_data: NA
  la: NA
  kpo_data: NA
  comms_data: NA
  info_data: NA
  staff_data: NA
  resp_data: NA
  fair_data: NA
  overall_data: NA
---

```{r echo = F}
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
```

```{r echo = F}
# The `params` object is available in the document.
kpo_data <- params$kpo_data
time_data <- params$time_data
comms_data <- params$comms_data
info_data <- params$info_data
staff_data <- params$staff_data
resp_data <- params$resp_data
fair_data <- params$fair_data
overall_data <- params$overall_data
la <- params$la
```


# Individual Questions

## Time taken
```{r echo=FALSE, comment= ""}
##Set up for time taken graph and text
#load data and split into Scotland and LA datasets
     text_prep <- function(dataset){
     qstnDta <- dataset
     qstnDta_LA <- qstnDta %>% filter(Selection == "LA")
     qstnDta_scot<- qstnDta %>% filter(Selection == "Scotland")
     #get total percentage good or very good 
     total_good <- filter(qstnDta_LA, value %in% c(1,2) & Selection == "LA") %>% pull(perc_resp) %>%
       sum()
     #if this is above 55% then overall is positive, otherwise negative/balances
     pos_or_neg <- ifelse(total_good > 0.55, "mainly positive", ifelse(total_good < 0.45, "mainly negative", "balanced"))
     
     # add "only" to the % positive if this is below 45
     if(total_good < 0.45) {
       total_good <- paste("only", total_good)
     } else{
       total_good <- total_good
     }
     
     #get the name for the maximum value in LA dataset. If more than one paste these together
     max_name <- as.character(qstnDta_LA %>% filter(n == max(n)) %>% pull(named_value))
     if(length(max_name >1)){
       max_name <- paste(max_name, collapse = " & ")
     }
     #Get the pecentage for the highest response and paste together if multiple
     max_perc <- qstnDta_LA %>% filter(n == max(n)) %>% pull(perc_resp)
     if(length(max_perc) >1){
       max_perc <- paste(paste(max_perc, collapse = " & "), "percent respectively.")
     } else{
       max_perc <- paste0(max_perc, " percent.")
     }
     
     #Get second highest value
     sec_val <- sort(qstnDta_LA$n, partial= 3)[3]
     #Filter for second highest value's name
     sec_name <- qstnDta_LA %>% filter(n == sec_val) %>% pull(named_value)
     if(length(sec_name) >1){
       sec_name <- paste(sec_name, collapse = " & ")
     }
     
     #Filter for second highest value's value
     sec_perc <- qstnDta_LA %>% filter(n == sec_val) %>% pull(perc_resp)
     if(length(sec_perc) >1){
       sec_perc <- paste(paste(sec_perc, collapse = " & "), "percent respectively.")
     }else{
       sec_perc <- paste0(sec_perc, " percent.")
     }
     
     #get most frequent response for Scotland
     scot_max_name <- as.character(qstnDta_scot %>% filter(n == max(n)) %>% pull(named_value))
     
     if(length(scot_max_name) >1){
       scot_max_name <- paste(scot_max_name, collapse = " & ")
     }
     #get percentage for most frequent Scotland level response
     scot_max_perc <- qstnDta_scot %>% filter(n == max(n)) %>% pull(perc_resp)
     if(length(scot_max_perc) >1){
       scot_max_perc <- paste(paste(scot_max_perc, collapse = " & "), "percent respectively.")
     } else{
       scot_max_perc <- paste0(scot_max_perc, " percent.")
     }
     #assign all objects as specifically for this question dataset
     objcts <- list(
     pos_or_neg,
     total_good,
     max_name,
     max_perc,
     sec_name,
     sec_perc,
     sec_name,
     sec_perc,
     scot_max_name,
     scot_max_perc)
     
     names(objcts) <- c("pos_or_neg","total_good","max_name", "max_perc","sec_name","sec_perc",
     "sec_name","sec_perc", "scot_max_name", "scot_max_perc")
     return(objcts)
     }

tm <- text_prep(time_data)
```
In this year for `r la` to date for the question "Thinking of your engagement, how satisfied were you with the time taken to complete the process?" responses have been `r tm$pos_or_neg` with `r tm$total_good` percent saying that they were very satisfied or satisfied. The greatest proportion of respondents said they were `r tm$max_name` at `r tm$max_perc` This was followed by `r tm$sec_name` at `r tm$sec_perc` For Scotland overall, most respondents said that they were `r tm$scot_max_name` at `r tm$scot_max_perc`


```{r echo = F}
     ggplot(data = time_data,
            aes(
         x = reorder(named_value, as.numeric(value)), 
         y = perc_resp, 
         fill = Selection)
         ) +
       geom_bar( 
         stat = "identity", 
         position = "dodge",
         width = 0.7,
         colour = "black") +
  geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"),
    name = ""
    )+
  ggtitle("Satisfaction with time taken - Year to Date")+
  xlab("Responses") +
  ylab("Percentage of Responses")+
  theme_classic()
```

## Communications
```{r echo=FALSE, comment= ""}
cm_txt <- text_prep(comms_data)
```
In this year for `r la` to date for the question "How would you rate the standard of communication provided?" responses have been `r cm_txt$pos_or_neg` with `r cm_txt$total_good` percent saying that they were very satisfied or satisfied. The greatest proportion of respondents said they were `r cm_txt$max_name` at `r cm_txt$max_perc` This was followed by `r cm_txt$sec_name` at `r cm_txt$sec_perc` For Scotland overall, most respondents said that they were `r cm_txt$scot_max_name` at `r cm_txt$scot_max_perc`

```{r echo = F}
     ggplot(data = comms_data,
            aes(
         x = reorder(named_value, as.numeric(value)), 
         y = perc_resp, 
         fill = Selection
         )) +
       geom_bar( 
         stat= "identity", 
         position = "dodge",
         width = 0.7,
         colour = "black"
         )+
   geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"), name = ""
  )+
  ggtitle("Standard of Communication - Year to Date")+
  xlab("Responses")+
  ylab("Percentage of Responses")+
  theme_classic()
```

## Information
```{r echo=FALSE, comment= ""}
inf_txt <- text_prep(info_data)
```
In this year for `r la` to date for the question "How would you rate the quality of information provided?" responses have been `r inf_txt$pos_or_neg` with `r inf_txt$total_good` percent saying that they were very satisfied or satisfied. The greatest proportion of respondents said they were `r inf_txt$max_name` at `r inf_txt$max_perc` This was followed by `r inf_txt$sec_name` at `r inf_txt$sec_perc` For Scotland overall, most respondents said that they were `r inf_txt$scot_max_name` at `r inf_txt$scot_max_perc`

```{r echo = F}
     ggplot(
       data = info_data,
       aes(x = reorder(named_value, as.numeric(value)), y = perc_resp, fill = Selection)
       )+
       geom_bar(
         stat= "identity", 
         position = "dodge",
         width = 0.7,
         colour = "black") +
  geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"),
    name = ""
    )+
  ggtitle("Quality of information - Year to Date")+
  xlab("Responses") +
  ylab("Percentage of Responses")+
  theme_classic()
```

## Staff
```{r echo=FALSE, comment= ""}
staff_txt <- text_prep(staff_data)
```
In this year for `r la` to date for the question "How would you rate the service offered by staff?" responses have been `r inf_txt$pos_or_neg` with `r inf_txt$total_good` percent saying that they were very satisfied or satisfied. The greatest proportion of respondents said they were `r inf_txt$max_name` at `r inf_txt$max_perc` This was followed by `r inf_txt$sec_name` at `r inf_txt$sec_perc` For Scotland overall, most respondents said that they were `r inf_txt$scot_max_name` at `r inf_txt$scot_max_perc`

```{r echo = F}
     ggplot(
       data = staff_data,
       aes(x = reorder(named_value, as.numeric(value)), y = perc_resp, fill = Selection)
       ) +
       geom_bar(
         stat= "identity", 
         position = "dodge",
         width = 0.7,
         colour = "black") +
  geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"),
    name = ""
    )+
  ggtitle("Service offered by staff - Year to Date")+
  xlab("Responses") +
  ylab("Percentage of Responses")+
  theme_classic()
         
```

## Responsiveness
```{r echo=FALSE, comment= ""}
resp_txt <- text_prep(resp_data)
```
In this year for `r la` to date for the question "How would you rate responsiveness to any queries or issues raised?" responses have been `r resp_txt$pos_or_neg` with `r resp_txt$total_good` percent saying that they were very satisfied or satisfied. The greatest proportion of respondents said they were `r resp_txt$max_name` at `r resp_txt$max_perc` This was followed by `r resp_txt$sec_name` at `r resp_txt$sec_perc` For Scotland overall, most respondents said that they were `r resp_txt$scot_max_name` at `r resp_txt$scot_max_perc`

```{r echo = F}
     ggplot(
       data = resp_data,
       aes(x = reorder(named_value, as.numeric(value)), y = perc_resp, fill = Selection)
       ) +
       geom_bar(
         stat= "identity", 
         position = "dodge",width = 0.7,
         colour = "black") +
  geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"),
    name = ""
    )+
  ggtitle("Responsiveness to queries or issues - Year to Date")+
  xlab("Responses") +
  ylab("Percentage of Responses")+
  theme_classic()
```

## Treated Fairly
```{r echo=FALSE, comment= ""}
fair_txt <- text_prep(fair_data)
```
In this year for `r la` to date for the question "How would you rate responsiveness to any queries or issues raised?" responses have been `r fair_txt$pos_or_neg` with `r fair_txt$total_good` percent saying that they were very satisfied or satisfied. The greatest proportion of respondents said they were `r fair_txt$max_name` at `r fair_txt$max_perc` This was followed by `r fair_txt$sec_name` at `r fair_txt$sec_perc` For Scotland overall, most respondents said that they were `r fair_txt$scot_max_name` at `r fair_txt$scot_max_perc`

```{r echo = F}
     ggplot(
       data = fair_data,
       aes(x = reorder(named_value, as.numeric(value)), y = perc_resp, fill =Selection)
       ) +
       geom_bar(
         stat= "identity", 
         position = "dodge",
         width = 0.7,
         colour = "black") +
  geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"),
    name = ""
    )+
  ggtitle("Would you agree you were treated fairly - Year to Date")+
  xlab("Responses") +
  ylab("Percentage of Responses")+
  theme_classic()
```

## Overall Satisfaction
```{r echo=FALSE, comment= ""}
ovr_txt <- text_prep(overall_data)
```
In this year for `r la` to date for the question "Overall, how satisfied were you with the service provided?" responses have been `r ovr_txt$pos_or_neg` with `r ovr_txt$total_good` percent saying that they were very satisfied or satisfied. The greatest proportion of respondents said they were `r ovr_txt$max_name` at `r ovr_txt$max_perc` This was followed by `r ovr_txt$sec_name` at `r ovr_txt$sec_perc` For Scotland overall, most respondents said that they were `r ovr_txt$scot_max_name` at `r ovr_txt$scot_max_perc`

```{r echo = F}
     ggplot(
       data = overall_data,
       aes(x = reorder(named_value, as.numeric(value)), y = perc_resp, fill = Selection)
       ) +
       geom_bar(
         stat= "identity", 
         position = "dodge",
         width = 0.7,
         colour = "black") +
  geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"),
    name = ""
    )+
  ggtitle("Overall satisfaction - Year to Date")+
  xlab("Responses") +
  ylab("Percentage of Responses")+
  theme_classic()
```