---
title: "Overview report"
output: pdf_document
params:
  time_data: NA
  la: NA
  type_data: NA
  reason_data: NA
  kpo_data: NA
  line_data: NA
  comms_data: NA
  info_data: NA
  staff_data: NA
  resp_data: NA
  fair_data: NA
  overall_data: NA
---

```{r echo = F}
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
```

```{r echo = F}
# The `params` object is available in the document.
kpo_data <- params$kpo_data
type_data <- params$type_data
reason_data <- params$reason_data
line_data <- params$line_data
time_data <- params$time_data
comms_data <- params$comms_data
info_data <- params$info_data
staff_data <- params$staff_data
resp_data <- params$resp_data
fair_data <- params$fair_data
overall_data <- params$overall_data
la <- params$la
```

## KPO 4 Score
```{r echo=FALSE, comment= ""}
## Set up text for KPO4 
kpo_data1 <- kpo_data %>% filter(`Tracking Link` == "Total")
local_auth <- "Aberdeen City" ##will need to select LA based on log in details
     curr_year <- yr2fy(2022)
     KPO4_ytd <- kpo_data1 %>% filter(id == "local authority") %>% pull(KPO_score)
     hilow_kpo4 <- ifelse(KPO4_ytd > 7.5, "higher", "lower")
     scotAv_kpo4 <- kpo_data1 %>% filter(id == "Scotland") %>% pull(KPO_score)
     abbel_kpo4 <- ifelse(KPO4_ytd > scotAv_kpo4, "higher", "lower")
     
```

This indicator summarises performance across all questions, with differential weightings based on importance. For `r la` in `r curr_year`, overall performance is at `r KPO4_ytd` for the year to date. This is `r abbel_kpo4` than the Scotland average of `r scotAv_kpo4` and `r hilow_kpo4` than the target value of 7.5.

```{r echo = F}
     
kpo_data1 <- kpo_data %>% filter(`Tracking Link` == "Total")
ggplot(data = kpo_data1,
            aes(
         x = `Tracking Link`, 
         y = KPO_score, 
         fill = id)
         ) +
       geom_bar( 
         stat = "identity", 
         position = "dodge",
         width = 0.7,
         colour = "black") +
  geom_text(aes(label = KPO_score, y = KPO_score + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_y_continuous(limits = c(0,11), expand = c(0, 0))+
  scale_fill_manual(
    values = c("local authority" = "cadetblue3", "Scotland" = "dimgrey"),
    name = ""
    )+
  ggtitle("KPO 4 score - Year to Date")+
  xlab("") +
  ylab("KPO 4 Score")+
  theme_classic()
```

# Respondent Type
```{r echo=FALSE, comment= ""}
# Set up text for respondent type
type_dta_filter <- resp_dta %>% filter(LA == 1 & question_type == "Type") ##filter by LA
     #get total responses for using as percentage denominator
     type_number <- type_dta_filter %>% 
       ungroup() %>% 
       filter(Question == "Agent/Designer") %>% 
       summarise_at(vars(`n`), sum) %>%
       select(`n`)
     #create variables for percentages for different groups
     agent_perc <- round(type_dta_filter[type_dta_filter$Question == "Agent/Designer" & type_dta_filter$value == 1 ,"perc"] *100, 1) %>% pull(perc)
     appli_perc <- round(type_dta_filter[type_dta_filter$Question == "Applicant" & type_dta_filter$value == 1 ,"perc"] *100, 1) %>% pull(perc)
     contr_perc <- round(type_dta_filter[type_dta_filter$Question == "Contractor" & type_dta_filter$value == 1 ,"perc"] *100, 1) %>% pull(perc)
     type_other_perc <- round(type_dta_filter[type_dta_filter$Question == "Other (please specify):" & type_dta_filter$value == 1 ,"perc"] *100, 1) %>% pull(perc)
     #if any are 0 then replace with "none"
     agent_perc <-ifelse(isEmpty(agent_perc), "none", paste0(agent_perc,"%"))
     appli_perc <-ifelse(isEmpty(appli_perc), "none", paste0(appli_perc,"%"))
     contr_perc <-ifelse(isEmpty(contr_perc), "none", paste0(contr_perc,"%"))
     type_other_perc <- ifelse(isEmpty(type_other_perc), "No respondents", paste0(type_other_perc, "%"))
```

Respondents were asked to provide details on the type of respondent they were, as well as their reason for contacting the Building Standards Service in `r la`. Of the `r type_number` respondents `r agent_perc` were agents or designers, `r appli_perc` were applicants and `r contr_perc` were contractors. `r type_other_perc` said they were an other respondent type.

```{r echo = F}
ggplot(data = type_data) +
        geom_col(aes(x = Question, y = perc
                 ),
                 fill = "cadetblue3", 
                 colour = "black"
                 )+
        coord_flip() +
        theme_classic()+
        scale_y_continuous( expand = c(0, 0))+
        ggtitle("Respondent Type: YTD")+
        xlab("Respondent Type")+
        ylab("Percentage of Responses")
```

# Response Reason
```{r echo=FALSE, comment= ""}
# Set up text for response reason
     resp_dta_filter <- resp_dta %>% filter(LA == 1 & question_type == "Reason") ##filter by LA
     ##Get a total no. of respondents for working out percentages
     resp_number <- resp_dta_filter %>% 
       ungroup() %>% 
       filter(Question == "To make an application for a building warrant") %>% 
       summarise_at(vars(`n`), sum) %>%
       select(`n`)
     #Calculate percentages for each response type
     discuss_perc <- round(resp_dta_filter[resp_dta_filter$Question == "To discuss your proposal before applying for a building warrant" & resp_dta_filter$value == 1 ,"perc"] *100, 1) %>% pull(perc)
     appli_perc <- round(resp_dta_filter[resp_dta_filter$Question == "To make an application for a building warrant" & resp_dta_filter$value == 1 ,"perc"] *100, 1) %>% pull(perc)
     constr_perc <- round(resp_dta_filter[resp_dta_filter$Question == "During construction, including submission of a completion certificate" & resp_dta_filter$value == 1 ,"perc"] *100, 1) %>% pull(perc)
     other_perc <- round(resp_dta_filter[resp_dta_filter$Question == "Other (please specify):" & resp_dta_filter$value == 1 ,"perc"] *100, 1) %>% pull(perc)
     
     #if any are 0 then replace with "none"
     discuss_perc <-ifelse(isEmpty(discuss_perc), "none", paste0(discuss_perc,"%"))
     appli_perc <-ifelse(isEmpty(appli_perc), "none", paste0(appli_perc,"%"))
     constr_perc <-ifelse(isEmpty(constr_perc), "none", paste0(constr_perc,"%"))
     other_perc <- ifelse(isEmpty(other_perc), "No respondents", paste0(other_perc, "%"))
     
```

Respondents were asked to provide details on the type of respondent they were, as well as their reason for contacting the Building Standards Service in `r la`. Of the `r resp_number` respondents, `r discuss_perc` contacted the local authority to discuss their proposal before applying for a building warrant, `r appli_perc` were making an application for a warrant and `r constr_perc` contacted the service during construction. `r other_perc` contacted the service for some other reason.

```{r echo = F}
ggplot(data = reason_data) +
        geom_col(aes(
          x = Question, 
          y = perc
          ),fill = "cadetblue3", colour = "black")+
        coord_flip() +
        theme_classic()+
        scale_y_continuous( expand = c(0, 0))+
         ggtitle("Response Reason:YTD")+
         xlab("Reason")+
         ylab("Percentage of Responses")
```

# KPO 4 Over Time
```{r echo=FALSE, comment= ""}
#get the number of quarters for rendering the text
     no_quarts <- length(unique(dta$`Tracking Link`))
    
    #filter to get KPO for quarter 1
    Q1_kpo <- kpo_data %>% filter(`Tracking Link` == "Quarter 1", id == "local authority") %>%
      pull(KPO_score)
    #render text for quarter 1
    Q1_text<- paste0("In Quarter 1 performance for KPO 4 calculated across all responses for all questions was ",
                      Q1_kpo,". ")
    #filter to get KPO for quarter 2
    Q2_kpo <- kpo_data %>% filter(`Tracking Link` == "Quarter 2", id == "local authority") %>%
      pull(KPO_score)
    #compare quarter 2 and quarter 1
    comp_Q12 <- ifelse(Q2_kpo > Q1_kpo+0.2, "rose", ifelse(Q2_kpo < Q1_kpo-0.2, "fell", "stayed the same "))
    #render text for quarter 2                   
    Q2_text<- paste0(Q1_text,"Performance then ", comp_Q12,
            "in Quarter 2 to stand at ", Q2_kpo)
    
    #filter to get KPO for quarter 3
    Q3_kpo <- kpo_data %>% filter(`Tracking Link` == "Quarter 3", id == "local authority") %>%
      pull(KPO_score)
    #compare quarter 3 and quarter 2 - ignore if error occurs
    comp_Q23 <- tryCatch({ifelse(Q3_kpo > Q3_kpo+0.2, "higher than", ifelse(Q3_kpo < Q3_kpo-0.2, "lower than", "the same as"))},error =function(error_message){""})
    #render text for quarter 3                   
    Q3_text<- paste0(Q1_text, Q2_text,"In Quarter 3 performance was ", comp_Q23,
                     " Quarter 2 at", Q3_kpo)
    
    #filter to get KPO for quarter 4
    Q4_kpo <- kpo_data %>% filter(`Tracking Link` == "Quarter 4", id == "local authority") %>%
      pull(KPO_score)
    #compare quarter 4 and quarter 3 - ignore if error occurs
    comp_Q34 <- tryCatch({ifelse(Q4_kpo > Q4_kpo+0.2, "higher than", ifelse(Q4_kpo < Q4_kpo-0.2, "lower than", "the same as"))},error =function(error_message){""})
    #render text for quarter 4                   
    Q3_text<- paste0(Q1_text, Q2_text, Q3_text, "In Quarter 4 performance is ", comp_Q34,
                     " Quarter 3, and stands at", Q4_kpo)
    
    final_text <- ifelse(no_quarts == 1, Q1_text, ifelse(no_quarts == 2, Q2_text, ifelse(no_quarts == 3, Q3_text, Q4_text)))
    
```    
    
`r ifelse(no_quarts == 1, Q1_text, ifelse(no_quarts == 2, Q2_text, ifelse(no_quarts == 3, Q3_text, Q4_text)))`
    
```{r echo = F}
ggplot(data = line_data) +
       geom_line(aes(
         x = `Tracking Link`, 
         y = KPO_score, 
         group = LA, 
         colour = LA
         ),
                lwd = 1)+
       scale_color_manual( 
            values = c("Aberdeen City" = "cadetblue3", "Scotland" = "dimgrey"), name = "")+
       ggtitle("KPO 4 score - over time")+
       ylim(0,10)+
       xlab("")+
       ylab("KPO 4 Score")+
       theme_classic()
```

# Individual Questions

## Time taken
```{r echo=FALSE, comment= ""}
##Set up for time taken graph and text
#load data and split into Scotland and LA datasets
     text_prep <- function(dataset){
     qstnDta <- dataset
     qstnDta_LA <- qstnDta %>% filter(Selection == "LA")
     qstnDta_scot<- qstnDta %>% filter(Selection == "Scotland")
     #get total percentage good or very good 
     total_good <- filter(qstnDta_LA, value %in% c(1,2) & Selection == "LA") %>% pull(perc_resp) %>%
       sum()
     #if this is above 55% then overall is positive, otherwise negative/balances
     pos_or_neg <- ifelse(total_good > 55, "mainly positive", ifelse(total_good < 45, "mainly negative", "balanced"))
     
     # add "only" to the % positive if this is below 45
     if(total_good < 45) {
       total_good <- paste("only", total_good)
     } else{
       total_good <- total_good
     }
     
     #get the name for the maximum value in LA dataset. If more than one paste these together
     max_name <- as.character(qstnDta_LA %>% filter(n == max(n)) %>% pull(named_value))
     if(length(max_name >1)){
       max_name <- paste(max_name, collapse = " & ")
     }
     #Get the pecentage for the highest response and paste together if multiple
     max_perc <- qstnDta_LA %>% filter(n == max(n)) %>% pull(perc_resp)
     if(length(max_perc) >1){
       max_perc <- paste(paste(max_perc, collapse = " & "), "percent respectively.")
     } else{
       max_perc <- paste0(max_perc, " percent.")
     }
     
     #Get second highest value
     sec_val <- sort(qstnDta_LA$n, partial= 3)[3]
     #Filter for second highest value's name
     sec_name <- qstnDta_LA %>% filter(n == sec_val) %>% pull(named_value)
     if(length(sec_name) >1){
       sec_name <- paste(sec_name, collapse = " & ")
     }
     
     #Filter for second highest value's value
     sec_perc <- qstnDta_LA %>% filter(n == sec_val) %>% pull(perc_resp)
     if(length(sec_perc) >1){
       sec_perc <- paste(paste(sec_perc, collapse = " & "), "percent respectively.")
     }else{
       sec_perc <- paste0(sec_perc, " percent.")
     }
     
     #get most frequent response for Scotland
     scot_max_name <- as.character(qstnDta_scot %>% filter(n == max(n)) %>% pull(named_value))
     
     if(length(scot_max_name) >1){
       scot_max_name <- paste(scot_max_name, collapse = " & ")
     }
     #get percentage for most frequent Scotland level response
     scot_max_perc <- qstnDta_scot %>% filter(n == max(n)) %>% pull(perc_resp)
     if(length(scot_max_perc) >1){
       scot_max_perc <- paste(paste(scot_max_perc, collapse = " & "), "percent respectively.")
     } else{
       scot_max_perc <- paste0(scot_max_perc, " percent.")
     }
     #assign all objects as specifically for this question dataset
     objcts <- list(
     pos_or_neg,
     total_good,
     max_name,
     max_perc,
     sec_name,
     sec_perc,
     sec_name,
     sec_perc,
     scot_max_name,
     scot_max_perc)
     
     names(objcts) <- c("pos_or_neg","total_good","max_name", "max_perc","sec_name","sec_perc",
     "sec_name","sec_perc", "scot_max_name", "scot_max_perc")
     return(objcts)
     }

tm <- text_prep(time_data)
```
In this year for `r la` to date for the question "Thinking of your engagement, how satisfied were you with the time taken to complete the process?" responses have been `r tm$pos_or_neg` with `r tm$total_good` percent saying that they were very satisfied or satisfied. The greatest proportion of respondents said they were `r tm$max_name` at `r tm$max_perc` This was followed by `r tm$sec_name` at `r tm$sec_perc` For Scotland overall, most respondents said that they were `r tm$scot_max_name` at `r tm$scot_max_perc`


```{r echo = F}
     ggplot(data = time_data,
            aes(
         x = reorder(named_value, as.numeric(value)), 
         y = perc_resp, 
         fill = Selection)
         ) +
       geom_bar( 
         stat = "identity", 
         position = "dodge",
         width = 0.7,
         colour = "black") +
  geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"),
    name = ""
    )+
  ggtitle("Satisfaction with time taken - Year to Date")+
  xlab("Responses") +
  ylab("Percentage of Responses")+
  theme_classic()
```

## Communications
```{r echo=FALSE, comment= ""}
cm_txt <- text_prep(comms_data)
```
In this year for `r la` to date for the question "How would you rate the standard of communication provided?" responses have been `r cm_txt$pos_or_neg` with `r cm_txt$total_good` percent saying that it was good or very good. The greatest proportion of respondents said they felt it was `r cm_txt$max_name` at `r cm_txt$max_perc` This was followed by `r cm_txt$sec_name` at `r cm_txt$sec_perc` For Scotland overall, most respondents said that communication was `r cm_txt$scot_max_name` at `r cm_txt$scot_max_perc`

```{r echo = F}
     ggplot(data = comms_data,
            aes(
         x = reorder(named_value, as.numeric(value)), 
         y = perc_resp, 
         fill = Selection
         )) +
       geom_bar( 
         stat= "identity", 
         position = "dodge",
         width = 0.7,
         colour = "black"
         )+
   geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"), name = ""
  )+
  ggtitle("Standard of Communication - Year to Date")+
  xlab("Responses")+
  ylab("Percentage of Responses")+
  theme_classic()
```

## Information
```{r echo=FALSE, comment= ""}
inf_txt <- text_prep(info_data)
```
In this year for `r la` to date for the question "How would you rate the quality of information provided?" responses have been `r inf_txt$pos_or_neg` with `r inf_txt$total_good` percent saying that it was good or very good. The greatest proportion of respondents said they felt it was `r inf_txt$max_name` at `r inf_txt$max_perc` This was followed by `r inf_txt$sec_name` at `r inf_txt$sec_perc` For Scotland overall, most respondents said that the information they received was `r inf_txt$scot_max_name` at `r inf_txt$scot_max_perc`

```{r echo = F}
     ggplot(
       data = info_data,
       aes(x = reorder(named_value, as.numeric(value)), y = perc_resp, fill = Selection)
       )+
       geom_bar(
         stat= "identity", 
         position = "dodge",
         width = 0.7,
         colour = "black") +
  geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"),
    name = ""
    )+
  ggtitle("Quality of information - Year to Date")+
  xlab("Responses") +
  ylab("Percentage of Responses")+
  theme_classic()
```

## Staff
```{r echo=FALSE, comment= ""}
staff_txt <- text_prep(staff_data)
```
In this year for `r la` to date for the question "How would you rate the service offered by staff?" responses have been `r staff_txt$pos_or_neg` with `r staff_txt$total_good` percent saying that it was good or very good. The greatest proportion of respondents said they felt it was `r staff_txt$max_name` at `r staff_txt$max_perc` This was followed by `r staff_txt$sec_name` at `r staff_txt$sec_perc` For Scotland overall, most respondents said that the service received was `r staff_txt$scot_max_name` at `r staff_txt$scot_max_perc`

```{r echo = F}
     ggplot(
       data = staff_data,
       aes(x = reorder(named_value, as.numeric(value)), y = perc_resp, fill = Selection)
       ) +
       geom_bar(
         stat= "identity", 
         position = "dodge",
         width = 0.7,
         colour = "black") +
  geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"),
    name = ""
    )+
  ggtitle("Service offered by staff - Year to Date")+
  xlab("Responses") +
  ylab("Percentage of Responses")+
  theme_classic()
         
```

## Responsiveness
```{r echo=FALSE, comment= ""}
resp_txt <- text_prep(resp_data)
```
In this year for `r la` to date for the question "How would you rate responsiveness to any queries or issues raised?" responses have been `r resp_txt$pos_or_neg` with `r resp_txt$total_good` percent saying that it was good or very good. The greatest proportion of respondents said they were `r resp_txt$max_name` at `r resp_txt$max_perc` This was followed by `r resp_txt$sec_name` at `r resp_txt$sec_perc` For Scotland overall, most respondents said that responsiveness was `r resp_txt$scot_max_name` at `r resp_txt$scot_max_perc`

```{r echo = F}
     ggplot(
       data = resp_data,
       aes(x = reorder(named_value, as.numeric(value)), y = perc_resp, fill = Selection)
       ) +
       geom_bar(
         stat= "identity", 
         position = "dodge",width = 0.7,
         colour = "black") +
  geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"),
    name = ""
    )+
  ggtitle("Responsiveness to queries or issues - Year to Date")+
  xlab("Responses") +
  ylab("Percentage of Responses")+
  theme_classic()
```

## Treated Fairly
```{r echo=FALSE, comment= ""}
fair_txt <- text_prep(fair_data)
```
In this year for `r la` to date for the question "To what extent would you agree that you were treated fairly?" responses have been `r fair_txt$pos_or_neg` with `r fair_txt$total_good` percent saying that they agree or strongly agree. The greatest proportion of respondents said they `r fair_txt$max_name` with the statement at `r fair_txt$max_perc` This was followed by `r fair_txt$sec_name` at `r fair_txt$sec_perc` For Scotland overall, most respondents said that they `r fair_txt$scot_max_name` at `r fair_txt$scot_max_perc`

```{r echo = F}
     ggplot(
       data = fair_data,
       aes(x = reorder(named_value, as.numeric(value)), y = perc_resp, fill =Selection)
       ) +
       geom_bar(
         stat= "identity", 
         position = "dodge",
         width = 0.7,
         colour = "black") +
  geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"),
    name = ""
    )+
  ggtitle("Would you agree you were treated fairly - Year to Date")+
  xlab("Responses") +
  ylab("Percentage of Responses")+
  theme_classic()
```

## Overall Satisfaction
```{r echo=FALSE, comment= ""}
ovr_txt <- text_prep(overall_data)
```
In this year for `r la` to date for the question "Overall, how satisfied were you with the service provided?" responses have been `r ovr_txt$pos_or_neg` with `r ovr_txt$total_good` percent saying that they were very satisfied or satisfied. The greatest proportion of respondents said they were `r ovr_txt$max_name` at `r ovr_txt$max_perc` This was followed by `r ovr_txt$sec_name` at `r ovr_txt$sec_perc` For Scotland overall, most respondents said that they were `r ovr_txt$scot_max_name` at `r ovr_txt$scot_max_perc`

```{r echo = F}
     ggplot(
       data = overall_data,
       aes(x = reorder(named_value, as.numeric(value)), y = perc_resp, fill = Selection)
       ) +
       geom_bar(
         stat= "identity", 
         position = "dodge",
         width = 0.7,
         colour = "black") +
  geom_text(aes(label = perc_resp, y = perc_resp + 1.2), 
                 vjust = 0,
                 position = position_dodge(width = 0.9) 
                 )+
  scale_fill_manual(
    values = c("LA" = "cadetblue3", "Scotland" = "dimgrey"),
    name = ""
    )+
  ggtitle("Overall satisfaction - Year to Date")+
  xlab("Responses") +
  ylab("Percentage of Responses")+
  theme_classic()
```